<!doctype HTML>
<html>
	<head>
		<title>CSS link[rel=preload]</title>
		<meta charset="utf-8">
		<link rel="preload" href="slow.css.php" as="style" onload="this.rel='stylesheet'">
		<script>
			// reduced feature test and polyfill for rel=preload.
			// make rel=preload links work where they otherwise won't
			(function( w ){
				var preloadSupported = function(){
			    try {
			      return w.document.createElement( "link" ).relList.supports( "preload" );
			    } catch (e) {
			      return false;
			    }
			  };

			  // loop preload links and fetch using loadCSS
		    var links = w.document.getElementsByTagName( "link" );
		    for( var i = 0; i < links.length; i++ ){
		      var link = links[ i ];
		      if( link.rel === "preload" && link.getAttribute( "as" ) === "style" ){
						var finalMedia = link.media || "all";
						var priorOnload = link.onload;
						function enableStylesheet(){
							link.rel = "stylesheet";
							link.media = finalMedia;
							if( w.localStorage ){
								try {
									w.localStorage[ link.href ] = true;
								} catch( e ){}
							}
						}
						if( w.localStorage && w.localStorage[ link.href ] ){
							return enableStylesheet();
						}
						// if preload isn't supported, get an asynchronous load by using a non-matching media attribute
						// then change that media back to its intended value on load
						link.onload = function(){
							enableStylesheet();
							if( priorOnload ){
								priorOnload.call( link );
							}
						};
						if( !preloadSupported() ){
							link.media = "x";
							link.rel = "stylesheet";
		      	}
						// supported or not, set rel=preload to stylesheet after 3 seconds,
						// which can combat a false positive support test
						setTimeout( enableStylesheet, 3000 );
					}
		    }
			})(this);
		</script>
	</head>
	<body>
		<h1>Async CSS w/ link[rel=preload]</h1>
		<p>This is a test page that references a slow-loading stylesheet using the new standard <code>link[rel=preload]</code>. It is not polyfilled, so it may never show CSS in some browsers.<p>

</body>
</html>
